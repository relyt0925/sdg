version: "1.0"
blocks:
  - name: gen_contexts
    type: LLMBlock
    config:
      config_path: ../../configs/skills/contexts.yaml
      output_cols:
        - context
      gen_kwargs:
        temperature: 1.0
        n: 10
        seed: 42
    drop_duplicates:
      - context
  - name: gen_grounded_questions
    type: LLMBlock
    config:
      config_path: ../../configs/skills/grounded_questions.yaml
      output_cols:
        - question
      batch_kwargs:
        num_samples: 3
    drop_duplicates:
      - question
  - name: eval_grounded_questions
    type: LLMBlock
    config:
      config_path: ../../configs/skills/evaluate_grounded_questions.yaml
      output_cols:
        - evaluation
        - score
  - name: filter_grounded_questions
    type: FilterByValueBlock
    config:
      filter_column: score
      filter_value: 1.0
      operation: eq
      convert_dtype: float
    drop_columns:
      - evaluation
      - score
      - num_samples
  - name: gen_grounded_responses
    type: LLMBlock
    config:
      config_path: ../../configs/skills/grounded_responses.yaml
      output_cols:
        - response
  - name: evaluate_grounded_qa_pair
    type: LLMBlock
    config:
      config_path: ../../configs/skills/evaluate_grounded_pair.yaml
      output_cols:
        - evaluation
        - score
  - name: filter_grounded_qa_pair
    type: FilterByValueBlock
    config:
      filter_column: score
      filter_value: 2.0
      operation: ge
      convert_dtype: float
  - name: combine_question_and_context
    type: CombineColumnsBlock
    config:
      columns:
        - context
        - question
      output_col: question
  - name: router
    type: LLMBlock
    config:
      config_path: ../../configs/skills/router.yaml
      output_cols:
        - route
      gen_kwargs:
        model: skill-classifier-v3-clm
        temperature: 0
        max_tokens: 1
        extra_body:
          allowed_token_ids:
            - 32001
            - 32002
            - 32003
            - 32004
            - 32005
            - 32006
            - 32007
            - 32008
  - name: icl_populator
    type: SamplePopulatorBlock
    config:
      config_paths:
        - ../../configs/domain_examples/skills/_A_.yaml
        - ../../configs/domain_examples/skills/_B_.yaml
        - ../../configs/domain_examples/skills/_C_.yaml
        - ../../configs/domain_examples/skills/_D_.yaml
        - ../../configs/domain_examples/skills/_E_.yaml
        - ../../configs/domain_examples/skills/_F_.yaml
        - ../../configs/domain_examples/skills/_G_.yaml
        - ../../configs/domain_examples/skills/_H_.yaml
      column_name: route
  - name: analyzer
    type: LLMBlock
    config:
      config_path: ../../configs/skills/analyzer.yaml
      output_cols:
        - analysis
        - rubric
  - name: critic
    type: LLMBlock
    config:
      config_path: ../../configs/skills/critic.yaml
      output_cols:
        - critique
  - name: planner
    type: LLMBlock
    config:
      config_path: ../../configs/skills/planner.yaml
      output_cols:
        - plan
  - name: revised_responder
    type: LLMBlock
    config:
      config_path: ../../configs/skills/revised_responder.yaml
      output_cols:
        - revised_response
    drop_columns:
      - icl_query
      - icl_response
      - icl_analysis
      - icl_rubric
      - icl_critique
      - icl_plan
      - icl_revised_response
  - name: judge
    type: LLMBlock
    config:
      config_path: ../../configs/skills/judge.yaml
      output_cols:
        - judgement
        - verdict
  - name: filter_judgement
    type: FilterByValueBlock
    config:
      filter_column: verdict
      filter_value:
        - Assistant A
        - Assistant B
      operation: contains
  - name: response_selector
    type: SelectorBlock
    config:
      choice_map:
         Assistant A: "response"
         Assistant B: "revised_response"
      choice_col: verdict
      output_col: chosen_reponse
    drop_columns:
      - judgemnent
      - verdict
